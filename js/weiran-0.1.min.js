/*
  Weiran Observing System Framework
  Copyright 2011-2011 Tian Yantao (yantaotian@foxmail.com).
*/var Weiran={theOS:null};Weiran.VERSION_NUMBER="0.1",Weiran.BROWSER_NAME=function(){var a="",b=navigator.userAgent.toLowerCase();return b.indexOf("opera")!=-1?a="opera":b.indexOf("msie")!=-1?a="msie":b.indexOf("safari")!=-1?a="safari":b.indexOf("mozilla")!=-1&&(b.indexOf("firefox")!=-1?a="firefox":a="mozilla"),a}(),Weiran.loadJsFile=function(a,b){if(!a||!b)return;var c=a.createElement("script");c.src=b,a.getElementsByTagName("head")[0].appendChild(c),c=null},Weiran.loadCssFile=function(a,b){if(!a||!b)return;var c=a.createElement("link");c.type="text/css",c.rel="stylesheet",c.href=b,a.getElementsByTagName("head")[0].appendChild(c),c=null},Weiran.removeJsFile=function(a,b){if(!a||!b)return;var c=a.getElementsByTagName("script");for(var d=c.length;d>=0;d--)c[d]&&c[d].src!=null&&c[d].src.indexOf(b)!=-1&&c[d].parentNode.removeChild(c[d]);c=null},Weiran.romveCssFile=function(a,b){if(!a||!b)return;var c=a.getElementsByTagName("link");for(var d=c.length;d>=0;d--)c[d]&&c[d].href!=null&&c[d].href.indexOf(b)!=-1&&c[d].parentNode.removeChild(c[d]);c=null},Weiran.replaceJsFile=function(a,b,c){if(!a||!b||!c)return;var d=a.getElementsByTagName("script");for(var e=d.length;e>=0;e--)if(d[e]&&d[e].src!=null&&d[e].src.indexOf(b)!=-1){var f=a.createElement("script");f.src=c,d[e].parentNode.replaceChild(f,d[e]),f=null}d=null},Weiran.replaceCssFile=function(a,b,c){if(!a||!b||!c)return;var d=a.getElementsByTagName("link");for(var e=d.length;e>=0;e--)if(d[e]&&d[e].href!=null&&d[e].href.indexOf(b)!=-1){var f=a.createElement("link");f.type="text/css",f.rel="stylesheet",f.href=c,d[e].parentNode.replaceChild(f,d[e]),f=null}d=null},Weiran.getScriptLocation=function(a){var b,c,d,e,f="";typeof a=="string"?b=new RegExp("(^|(.*?\\/))("+a+")(\\?|$)"):b=new RegExp("(^|(.*?\\/))(weiran-"+Weiran.VERSION_NUMBER+".min.js)(\\?|$)"),c=document.getElementsByTagName("script");for(var g=0,h=c.length;g<h;g++){d=c[g].getAttribute("src");if(d){var e=d.match(b);if(e){f=e[1];break}}}return f},Weiran.inherit=function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c;var d,e,f;for(d=2,e=arguments.length;d<e;d++)f=arguments[d],typeof f=="function"&&(f=f.prototype),Weiran.extend(a.prototype,f)},Weiran.extend=function(a,b){a=a||{};if(b){for(var c in b){var d=b[c];d!==undefined&&(a[c]=d)}var e=typeof window.Event=="function"&&b instanceof window.Event;!e&&b.hasOwnProperty&&b.hasOwnProperty("toString")&&(a.toString=b.toString)}return a},Weiran.Class=function(){var a=arguments.length,b=arguments[0],c=arguments[a-1],d=typeof c.initialize=="function"?c.initialize:function(){b.apply(this,arguments)};if(a>1){var e=[d,b].concat(Array.prototype.slice.call(arguments).slice(1,a-1),c);Weiran.inherit.apply(null,e)}else d.prototype=c;return d},Weiran.Lang={code:null,defaultCode:"en",getCode:function(){return Weiran.Lang.code||Weiran.Lang.setCode(),Weiran.Lang.code},setCode:function(a){var b;a||(a=Weiran.BROWSER_NAME=="msie"?navigator.userLanguage:navigator.language);var c=a.split("-");c[0]=c[0].toLowerCase(),typeof Weiran.Lang[c[0]]=="object"&&(b=c[0]);if(c[1]){var d=c[0]+"-"+c[1].toUpperCase();typeof Weiran.Lang[d]=="object"&&(b=d)}b||(b=Weiran.Lang.defaultCode),Weiran.Lang.code=b},translate:function(a){var b=Weiran.Lang[Weiran.Lang.getCode()],c=b&&b[a];return c||(c=a),c},add:function(a,b,c){return!a||!b||!c||a!=="en"&&a!=="zh-CN"?!1:(typeof Weiran.Lang[a]!="object"&&(Weiran.Lang[a]={}),typeof Weiran.Lang[a][b]=="string"?!1:(Weiran.Lang[a][b]=c,!0))}},Weiran.i18n=Weiran.Lang.translate,Weiran.Sensor=Weiran.Class(OpenLayers.WeMarker,{rtsvr:null,htsvr:null,socket:null,vibrateTimer:null,initialize:function(a){OpenLayers.WeMarker.prototype.initialize.apply(this,arguments),this.i18n(),typeof a=="object"&&(this.rtsvr=a.realtimeserver?a.realtimeserver:"",this.htsvr=a.historyserver?a.historyserver:""),typeof this.rtsvr=="string"&&this.rtsvr!==""&&typeof io=="object"&&(this.socket=io.connect(this.rtsvr)),this.socket!=null&&(this.socket.on("connect",this.onConnect(this)),this.socket.on("disconnect",this.onDisconnect(this)),this.socket.on("message",this.onMessage(this)),this.socket.on("sensordata",this.onSensorData(this)))},destroy:function(){this.socket!=null&&(this.socket.disconnect(),this.socket=null),this.isVibrating()&&this.vibrateOff(),OpenLayers.WeMarker.prototype.destroy.apply(this,arguments)},i18n:function(){},vibrateOn:function(a,b){if(this.marker==null)return;var c=a?Math.abs(a):1,d=b?Math.abs(b):2,e=!1;this.vibrateTimer=setInterval(function(a,b,c){return function(){var d=a.marker.icon.size.clone();c?(a.marker.icon.setSize(a.markerSize.clone()),c=!1):(d.w=d.w*b,d.h=d.h*b,a.marker.icon.setSize(d),c=!0)}}(this,d,e),1e3/c)},vibrateOff:function(){clearInterval(this.vibrateTimer),this.vibrateTimer=null,this.marker!=null&&this.marker.icon.setSize(this.markerSize.clone())},isVibrating:function(){return this.vibrateTimer!=null?!0:!1},onClick:function(){OpenLayers.WeMarker.prototype.onClick.apply(this,arguments),this.isVibrating()&&this.vibrateOff()},onConnect:function(a){return function(){}},onDisconnect:function(a){return function(){}},onMessage:function(a){return function(a){}},onSensorData:function(a){return function(a){}},CLASS_NAME:"Weiran.Sensor"}),Weiran.Lang["zh-CN"]={WeApp:"未然嵌入式应用",end:"结束"},Weiran.App=Weiran.Class({div:null,childTitle:null,childIcon:null,title:null,iconUrl:null,pageUrl:null,framed:!0,active:!1,window:null,initialize:function(a,b,c){typeof a=="string"&&a!==""?(this.iconUrl="apps/"+a+"/icon.png",this.pageUrl="apps/"+a+"/index.html"):typeof OpenLayers=="object"&&(this.iconUrl=OpenLayers.ImgPath+"app_icon_default.png",this.pageUrl=""),typeof b=="object"&&typeof b[Weiran.Lang.getCode()]=="string"?this.title=b[Weiran.Lang.getCode()]:this.title=Weiran.i18n("WeApp")+(a?" "+a:""),this.framed=c===!1?!1:!0},destroy:function(){this.active&&(this.window.close(),this.window=null,this.active=!1),OpenLayers.Event.stopObservingElement(this.div),this.div.parentNode&&this.div.parentNode.removeChild(this.div),this.div=null,this.childIcon=null,this.childTitle=null},draw:function(){return this.div==null&&(this.div=document.createElement("div")),this.div.className="olWeApp",typeof this.iconUrl=="string"&&this.iconUrl!==""&&(this.childIcon=document.createElement("img"),this.childIcon.src=this.iconUrl,this.div.appendChild(this.childIcon)),typeof this.title=="string"&&(this.childTitle=document.createElement("p"),this.childTitle.innerHTML=this.title,this.div.appendChild(this.childTitle)),OpenLayers.Event.observe(this.div,"click",OpenLayers.Function.bindAsEventListener(this.onOpen,this)),this.div},onOpen:function(a){var b=Weiran.theOS.getManager();this.active?this.window.select():(this.window=b.createWindow({title:this.title,width:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_ww")):null,height:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_wh")):null,x:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_wx")):null,y:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_wy")):null,state:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_ws")):"window",iconImageURL:this.iconUrl}),this.active=!0,this.skipMapEvents(),this.window.getComponent("close").onclick=function(a){return function(){confirm(OpenLayers.i18n("WeMainPanel_confirm"))?a.close():a._iconify()}}(this.window),typeof this.pageUrl=="string"?this.framed?this.window.loadUrlX(this.pageUrl,function(a){return function(b){b.onclose=a.onClose(a),b.onmove=a.onMove(a),b.onresize=a.onResize(a)}}(this)):this.window.loadUrl(this.pageUrl,function(a){return function(b){b.onclose=a.onClose(a),b.onmove=a.onMove(a),b.onresize=a.onResize(a)}}(this),function(a){return function(b){b.onclose=a.onClose(a),b.onmove=a.onMove(a),b.onresize=a.onResize(a)}}(this)):(this.window.onclose=this.onClose(this),this.window.onmove=this.onMove(this),this.window.onresize=this.onResize(this))),a!=null&&OpenLayers.Event.stop(a)},setTitle:function(a){typeof a=="string"&&(this.title=a,this.childTitle.innerHTML=this.title)},setIcon:function(a){typeof a=="string"&&a!==""&&(this.iconUrl=a,this.childIcon.src=this.iconUrl)},onClose:function(a){return function(){a.active=!1,a.window=null}},onMove:function(a){return function(b,c){if($&&$.cookies&&$.md5){var d={expiresAt:new Date(2099,12,31)};$.cookies.set($.md5(a.title+"_wx"),b+"",d),$.cookies.set($.md5(a.title+"_wy"),c+"",d)}}},onResize:function(a){return function(b,c,d){if($&&$.cookies&&$.md5){var e={expiresAt:new Date(2099,12,31)};switch(d){case"resize":$.cookies.set($.md5(a.title+"_ww"),b+"",e),$.cookies.set($.md5(a.title+"_wh"),c+"",e);break;case"maximize":$.cookies.set($.md5(a.title+"_ws"),"maximized",e);break;case"restore":$.cookies.set($.md5(a.title+"_ws"),"window",e)}}}},skipMapEvents:function(){if(jwim&&this.window instanceof jwim.Window){var a=this.window.getComponent("window");OpenLayers.Event.observe(a,"mousedown",OpenLayers.Function.bindAsEventListener(this._stopEvents,this)),OpenLayers.Event.observe(a,"click",OpenLayers.Function.bindAsEventListener(this._stopEvents,this)),OpenLayers.Event.observe(a,"dblclick",OpenLayers.Function.bindAsEventListener(this._stopEvents,this))}},_stopEvents:function(a){OpenLayers.Event.stop(a,!0)},CLASS_NAME:"Weiran.App"}),Weiran.OS=Weiran.Class({map:null,mapCanvasId:null,wm:null,wmTaskBar:null,accountDataHost:null,theme:"default",events:null,EVENT_TYPES:["signin","logout"],account:null,initialize:function(a,b){this.mapCanvasId=a,this.accountDataHost=b,Weiran.theOS!=null&&Weiran.theOS.exit(),Weiran.theOS=this,OpenLayers.ProxyHost="/cgi-bin/proxy.cgi?url="},boot:function(){var a=Weiran.getScriptLocation()+"theme/"+this.theme+"/style.css";Weiran.loadCssFile(document,a),this.updateImgPath(),this.events=new OpenLayers.Events(this,null,this.EVENT_TYPES,!0,{includeXY:!0}),this.createMapInstance(),this.createWindowManager(),this.events.register("signin",this,this.onSignIn),this.events.register("logout",this,this.onLogOut)},exit:function(){this.map!=null&&(this.map.destroy(),this.sensorsLayer=null,this.map=null),this.events!=null&&(this.events.destroy(),this.events=null);var a=this.wm.getAllWindows();for(var b=0;b<a.length;b++)a[b].close();this.wm=null},updateImgPath:function(){OpenLayers.ImgPath=Weiran.getScriptLocation()+"theme/"+this.theme+"/img/"},createWindowManager:function(){var a;this.map&&(a=this.map.getControlsByClass("OpenLayers.Control.WeTaskbar"),a&&a.length>0&&(this.wmTaskBar=a[0].div));var b=document.getElementById(this.mapCanvasId);b&&(b.style.overflow="hidden",b.style.position="relative"),this.wm=new jwim.Manager({container:b,taskbar:this.wmTaskBar,defaultX:50,defaultY:35,iconWidth:36,cacheXHR:!0})},createMapInstance:function(){this.map=new OpenLayers.Map(this.mapCanvasId,{theme:null,projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),units:"m",maxResolution:156543.0339,maxExtent:new OpenLayers.Bounds(-20037509,-20037508.34,20037508.34,20037508.34),layers:[new OpenLayers.Layer.OSM(OpenLayers.i18n("OSM_Mapnik"),["http://a.tile.openstreetmap.org/${z}/${x}/${y}.png","http://b.tile.openstreetmap.org/${z}/${x}/${y}.png","http://c.tile.openstreetmap.org/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='www.openstreetmap.org' >Open Street Map</a>"}),new OpenLayers.Layer.OSM(OpenLayers.i18n("OSM_Osmarender"),["http://a.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png","http://b.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png","http://c.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='www.openstreetmap.org' >Open Street Map</a>",numZoomLevels:18}),new OpenLayers.Layer.OSM(OpenLayers.i18n("OSM_Cycle"),["http://a.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png","http://b.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png","http://c.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='www.opencyclemap.org' >Open Cycle Map</a>",numZoomLevels:17}),new OpenLayers.Layer.OSM(OpenLayers.i18n("OSM_Transport"),["http://a.tile2.opencyclemap.org/transport/${z}/${x}/${y}.png","http://b.tile2.opencyclemap.org/transport/${z}/${x}/${y}.png","http://c.tile2.opencyclemap.org/transport/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='www.opencyclemap.org' >Open Cycle Map</a>"}),new OpenLayers.Layer.OSM(OpenLayers.i18n("OSM_MapQuest"),["http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png","http://otile2.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png","http://otile3.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png","http://otile4.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='www.mapquest.com' >MapQuest Open</a>"})],controls:[new OpenLayers.Control.Navigation,new OpenLayers.Control.KeyboardDefaults,new OpenLayers.Control.PanZoomBar,new OpenLayers.Control.Attribution,new OpenLayers.Control.ScaleLine({maxWidth:150,geodesic:!0}),new OpenLayers.Control.MousePosition({numDigits:6,displayProjection:new OpenLayers.Projection("EPSG:4326")}),new OpenLayers.Control.LoadingPanel,new OpenLayers.Control.WeMainPanel,new OpenLayers.Control.WeTaskbar,new OpenLayers.Control.WeOverviewMap]});if($&&$.cookies&&$.md5){var a=$.cookies.get($.md5(this.CLASS_NAME+"_mapcenterlon")),b=$.cookies.get($.md5(this.CLASS_NAME+"_mapcenterlat"));a!==null&&b!==null?this.map.setCenter((new OpenLayers.LonLat(a,b)).transform(this.map.displayProjection,this.map.getProjectionObject())):this.map.zoomToMaxExtent()}else this.map.zoomToMaxExtent();this.map.events.register("moveend",this,this.onMapMoveEnd),this.map.events.register("zoomend",this,this.onMapZoomEnd)},createAccount:function(){var a=new OpenLayers.Layer.WeAccounts;this.map&&this.map.addLayer(a),this.account=new Weiran.Sensor.Account({title:OpenLayers.i18n("WeAccount_name"),lon:0,lat:0,iconurl:OpenLayers.Util.getImagesLocation()+"we_account.png",realtimeserver:this.accountDataHost}),a.addMarker(this.account)},changeTheme:function(a){var b,c,d;if(a&&a!=this.theme){b=Weiran.getScriptLocation(),c=b+"theme/"+a+"/style.css",d=b+"theme/"+this.theme+"/style.css",Weiran.replaceCssFile(document,d,c),this.theme=a,this.updateImgPath();var e=this.map.getControlsByClass("OpenLayers.Control.PanZoomBar");e&&e.length>0&&e[0].redraw()}},onMapMoveEnd:function(a){if($&&$.cookies&&$.md5){var b=this.map.getCenter().transform(this.map.getProjectionObject(),this.map.displayProjection);$.cookies.set($.md5(this.CLASS_NAME+"_mapcenterlon"),b.lon+"",{expiresAt:new Date(2099,12,32)}),$.cookies.set($.md5(this.CLASS_NAME+"_mapcenterlat"),b.lat+"",{expiresAt:new Date(2099,12,32)}),b=null}},onMapZoomEnd:function(a){$&&$.cookies&&$.md5&&$.cookies.set($.md5(this.CLASS_NAME+"_mapzoom"),this.map.getZoom()+"",{expiresAt:new Date(2099,12,32)})},onSignIn:function(a){if(!a.account)return;this.applyAccountData(a.account)},applyAccountData:function(a){var b;a.lon&&a.lat&&this.map.setCenter((new OpenLayers.LonLat(a.lon,a.lat)).transform(this.map.displayProjection,this.map.getProjectionObject()),5),a.theme&&this.changeTheme(a.theme),this.accountsLayer==null&&(this.accountsLayer=new OpenLayers.Layer.WeSensors(OpenLayers.i18n("WeSensors_users")),this.map.addLayer(this.accountsLayer),this.accountsLayer.addSensor(new OpenLayers.WeSensor.WeAccount(a)));if(a.sensors&&a.sensors.length>0&&this.sensorsLayer==null){this.sensorsLayer=new OpenLayers.Layer.WeSensors,this.map.addLayer(this.sensorsLayer);for(b=0;b<a.sensors.length;b++)switch(a.sensors[b].type.toLowerCase()){case"wegt02a":this.sensorsLayer.addSensor(new OpenLayers.WeSensor.WeGT02A(a.sensors[b]));break;default:}}},onLogOut:function(a){this.accountsLayer!=null&&(this.map.removeLayer(this.accountsLayer),this.accountsLayer.destroy(),this.accountsLayer=null),this.sensorsLayer!=null&&(this.map.removeLayer(this.sensorsLayer),this.sensorsLayer.destroy(),this.sensorsLayer=null),this.account=null},getMap:function(){return this.map},getManager:function(){return this.wm},getEvents:function(){return this.events},getMainPanel:function(){var a=this.map.getControlsByClass("OpenLayers.Control.WeMainPanel");return a.length>0?a[0]:null},getAccount:function(){return this.account},CLASS_NAME:"Weiran.OS"}),Weiran.Lang.en={WeApp:"Weiran Embeded Application",end:"end"};