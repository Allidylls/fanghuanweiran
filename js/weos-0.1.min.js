//=============================================================
// Weiran Observing System Framework
// Copyright 2011-2012 Tian Yantao (yantaotian@foxmail.com).
//-------------------------------------------------------------
Weiran.Sensor=Weiran.Class(OpenLayers.WeMarker,{rtsvr:null,htsvr:null,socket:null,vibrateTimer:null,initialize:function(a){OpenLayers.WeMarker.prototype.initialize.apply(this,arguments),this.windowFramed=!0,this.i18n(),typeof a=="object"&&(this.rtsvr=a.realtimeserver?a.realtimeserver:"",this.htsvr=a.historyserver?a.historyserver:""),typeof this.rtsvr=="string"&&this.rtsvr!==""&&typeof io=="object"&&(this.socket=io.connect(this.rtsvr)),this.socket!=null&&(this.socket.on("connect",function(a){return function(){a.onConnect()}}(this)),this.socket.on("disconnect",function(a){return function(){a.onDisconnect()}}(this)),this.socket.on("message",function(a){return function(b){a.onMessage(b)}}(this)),this.socket.on("sensordata",function(a){return function(b){a.onSensorData(b)}}(this)))},destroy:function(){this.socket!=null&&(this.socket.disconnect(),this.socket=null),this.isVibrating()&&this.vibrateOff(),OpenLayers.WeMarker.prototype.destroy.apply(this,arguments)},i18n:function(){},vibrateOn:function(a,b){if(this.marker==null)return;var c=a?Math.abs(a):1,d=b?Math.abs(b):2,e=!1;this.vibrateTimer=setInterval(function(a,b,c){return function(){var d=a.marker.icon.size.clone();c?(a.marker.icon.setSize(a.markerSize.clone()),c=!1):(d.w=d.w*b,d.h=d.h*b,a.marker.icon.setSize(d),c=!0)}}(this,d,e),1e3/c)},vibrateOff:function(){clearInterval(this.vibrateTimer),this.vibrateTimer=null,this.marker!=null&&this.marker.icon.setSize(this.markerSize.clone())},isVibrating:function(){return this.vibrateTimer!=null?!0:!1},onClick:function(){OpenLayers.WeMarker.prototype.onClick.apply(this,arguments),this.isVibrating()&&this.vibrateOff()},onConnect:function(){},onDisconnect:function(){},onMessage:function(a){},onSensorData:function(a){},CLASS_NAME:"Weiran.Sensor"}),Weiran.Event={observers:!1,KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,element:function(a){return a.target||a.srcElement},isSingleTouch:function(a){return a.touches&&a.touches.length==1},isMultiTouch:function(a){return a.touches&&a.touches.length>1},isLeftClick:function(a){return a.which&&a.which==1||a.button&&a.button==1},isRightClick:function(a){return a.which&&a.which==3||a.button&&a.button==2},stop:function(a,b){b||(a.preventDefault?a.preventDefault():a.returnValue=!1),a.stopPropagation?a.stopPropagation():a.cancelBubble=!0},findElement:function(a,b){var c=Weiran.Event.element(a);while(c.parentNode&&(!c.tagName||c.tagName.toUpperCase()!=b.toUpperCase()))c=c.parentNode;return c},observe:function(a,b,c,d){var e=Weiran.getElement(a);d=d||!1,b=="keypress"&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||e.attachEvent)&&(b="keydown"),this.observers||(this.observers={});if(!e._eventCacheID){var f="eventCacheID_";e.id&&(f=e.id+"_"+f),e._eventCacheID=Weiran.createUniqueID(f)}var g=e._eventCacheID;this.observers[g]||(this.observers[g]=[]),this.observers[g].push({element:e,name:b,observer:c,useCapture:d}),e.addEventListener?e.addEventListener(b,c,d):e.attachEvent&&e.attachEvent("on"+b,c)},stopObservingElement:function(a){var b=Weiran.getElement(a),c=b._eventCacheID;this._removeElementObservers(Weiran.Event.observers[c])},_removeElementObservers:function(a){if(a)for(var b=a.length-1;b>=0;b--)var c=a[b],d=new Array(c.element,c.name,c.observer,c.useCapture),e=Weiran.Event.stopObserving.apply(this,d)},stopObserving:function(a,b,c,d){d=d||!1;var e=Weiran.getElement(a),f=e._eventCacheID;b=="keypress"&&(navigator.appVersion.match(/Konqueror|Safari|KHTML/)||e.detachEvent)&&(b="keydown");var g=!1,h=Weiran.Event.observers[f];if(h){var i=0;while(!g&&i<h.length){var j=h[i];if(j.name==b&&j.observer==c&&j.useCapture==d){h.splice(i,1),h.length==0&&delete Weiran.Event.observers[f],g=!0;break}i++}}return g&&(e.removeEventListener?e.removeEventListener(b,c,d):e&&e.detachEvent&&e.detachEvent("on"+b,c)),g},unloadCache:function(){if(Weiran.Event&&Weiran.Event.observers){for(var a in Weiran.Event.observers){var b=Weiran.Event.observers[a];Weiran.Event._removeElementObservers.apply(this,[b])}Weiran.Event.observers=!1}}},Weiran.Event.observe(window,"unload",Weiran.Event.unloadCache,!1);if(window.Event)Weiran.applyDefaults(window.Event,Weiran.Event);else var Event=Weiran.Event;Weiran.Events=Weiran.Class({BROWSER_EVENTS:["mouseover","mouseout","mousedown","mouseup","mousemove","click","dblclick","rightclick","dblrightclick","resize","focus","blur","touchstart","touchmove","touchend"],listeners:null,object:null,element:null,eventTypes:null,eventHandler:null,fallThrough:null,includeXY:!1,clearMouseListener:null,initialize:function(a,b,c,d,e){Weiran.extend(this,e),this.object=a,this.fallThrough=d,this.listeners={},this.eventHandler=Weiran.Function.bindAsEventListener(this.handleBrowserEvent,this),this.clearMouseListener=Weiran.Function.bind(this.clearMouseCache,this),this.eventTypes=[];if(c!=null)for(var f=0,g=c.length;f<g;f++)this.addEventType(c[f]);b!=null&&this.attachToElement(b)},destroy:function(){this.element&&(Weiran.Event.stopObservingElement(this.element),this.element.hasScrollEvent&&Weiran.Event.stopObserving(window,"scroll",this.clearMouseListener)),this.element=null,this.listeners=null,this.object=null,this.eventTypes=null,this.fallThrough=null,this.eventHandler=null},addEventType:function(a){this.listeners[a]||(this.eventTypes.push(a),this.listeners[a]=[])},attachToElement:function(a){this.element&&Weiran.Event.stopObservingElement(this.element),this.element=a;for(var b=0,c=this.BROWSER_EVENTS.length;b<c;b++){var d=this.BROWSER_EVENTS[b];this.addEventType(d),Weiran.Event.observe(a,d,this.eventHandler)}Weiran.Event.observe(a,"dragstart",Weiran.Event.stop)},on:function(a){for(var b in a)b!="scope"&&this.register(b,a.scope,a[b])},register:function(a,b,c){if(c!=null&&Weiran.indexOf(this.eventTypes,a)!=-1){b==null&&(b=this.object);var d=this.listeners[a];d.push({obj:b,func:c})}},registerPriority:function(a,b,c){if(c!=null){b==null&&(b=this.object);var d=this.listeners[a];d!=null&&d.unshift({obj:b,func:c})}},un:function(a){for(var b in a)b!="scope"&&this.unregister(b,a.scope,a[b])},unregister:function(a,b,c){b==null&&(b=this.object);var d=this.listeners[a];if(d!=null)for(var e=0,f=d.length;e<f;e++)if(d[e].obj==b&&d[e].func==c){d.splice(e,1);break}},remove:function(a){this.listeners[a]!=null&&(this.listeners[a]=[])},triggerEvent:function(a,b){var c=this.listeners[a];if(!c||c.length==0)return undefined;b==null&&(b={}),b.object=this.object,b.element=this.element,b.type||(b.type=a),c=c.slice();var d;for(var e=0,f=c.length;e<f;e++){var g=c[e];d=g.func.apply(g.obj,[b]);if(d!=undefined&&d==0)break}return this.fallThrough||Weiran.Event.stop(b,!0),d},handleBrowserEvent:function(a){var b=a.type,c=this.listeners[b];if(!c||c.length==0)return;var d=a.touches;if(d&&d[0]){var e=0,f=0,g=d.length,h;for(var i=0;i<g;++i)h=d[i],e+=h.clientX,f+=h.clientY;a.clientX=e/g,a.clientY=f/g}this.includeXY&&(a.xy=this.getMousePosition(a)),this.triggerEvent(b,a)},clearMouseCache:function(){this.element.scrolls=null,this.element.lefttop=null;var a=document.body;a&&(a.scrollTop==0&&a.scrollLeft==0||!navigator.userAgent.match(/iPhone/i))&&(this.element.offsets=null)},getMousePosition:function(a){this.includeXY?this.element.hasScrollEvent||(Weiran.Event.observe(window,"scroll",this.clearMouseListener),this.element.hasScrollEvent=!0):this.clearMouseCache();if(!this.element.scrolls){var b=Weiran.getViewportElement();this.element.scrolls=[b.scrollLeft,b.scrollTop]}this.element.lefttop||(this.element.lefttop=[document.documentElement.clientLeft||0,document.documentElement.clientTop||0]),this.element.offsets||(this.element.offsets=Weiran.pagePosition(this.element));var c={x:a.clientX+this.element.scrolls[0]-this.element.offsets[0]-this.element.lefttop[0],y:a.clientY+this.element.scrolls[1]-this.element.offsets[1]-this.element.lefttop[1]};return c},CLASS_NAME:"Weiran.Events"}),Weiran.Lang.add("en","WeApp","Weiran Embeded Application"),Weiran.Lang.add("en","weAppConfirm","Press [OK] to close, or [Cancel] to minimize the window."),Weiran.Lang.add("zh-CN","WeApp","未然嵌入式应用"),Weiran.Lang.add("zh-CN","weAppConfirm","按【确认】关闭，或按【取消】最小化窗口。"),Weiran.App=Weiran.Class({div:null,childTitle:null,childIcon:null,title:null,iconUrl:null,pageUrl:null,framed:!0,active:!1,window:null,initialize:function(a){a&&a.title&&typeof a.title[Weiran.Lang.getCode()]=="string"?this.title=a.title[Weiran.Lang.getCode()]:this.title=Weiran.i18n("WeApp"),this.iconUrl=a&&a.iconurl?a.iconurl:Weiran.imagePath+"app_icon_default.png",this.pageUrl=a&&a.windowurl?a.windowurl:"",this.framed=!0},destroy:function(){this.active&&(this.window.close(),this.window=null,this.active=!1),Weiran.Event.stopObservingElement(this.div),this.div.parentNode&&this.div.parentNode.removeChild(this.div),this.div=null,this.childIcon=null,this.childTitle=null},draw:function(){return this.div==null&&(this.div=document.createElement("div")),this.div.className="olWeApp",typeof this.iconUrl=="string"&&this.iconUrl!==""&&(this.childIcon=document.createElement("img"),this.childIcon.src=this.iconUrl,this.div.appendChild(this.childIcon)),typeof this.title=="string"&&(this.childTitle=document.createElement("p"),this.childTitle.innerHTML=this.title,this.div.appendChild(this.childTitle)),Weiran.Event.observe(this.div,"click",Weiran.Function.bindAsEventListener(this.onOpen,this)),this.div},onOpen:function(a){if(Weiran.theOS==null)return;var b=Weiran.theOS.getManager();this.active?this.window.select():(this.window=b.createWindow({title:this.title,width:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_ww")):null,height:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_wh")):null,x:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_wx")):null,y:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_wy")):null,state:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_ws")):"window",iconImageURL:this.iconUrl}),this.active=!0,this.window.getComponent("close").onclick=function(a){return function(){confirm(Weiran.i18n("weAppConfirm"))?a.close():a._iconify()}}(this.window),typeof this.pageUrl=="string"&&this.pageUrl!==""?this.framed?this.window.loadUrlX(this.pageUrl,function(a){return function(b){b.onclose=a.onClose(a),b.onmove=a.onMove(a),b.onresize=a.onResize(a)}}(this)):this.window.loadUrl(this.pageUrl,function(a){return function(b){b.onclose=a.onClose(a),b.onmove=a.onMove(a),b.onresize=a.onResize(a)}}(this),function(a){return function(b){b.onclose=a.onClose(a),b.onmove=a.onMove(a),b.onresize=a.onResize(a)}}(this)):(this.window.onclose=this.onClose(this),this.window.onmove=this.onMove(this),this.window.onresize=this.onResize(this))),a!=null&&Weiran.Event.stop(a)},setTitle:function(a){typeof a=="string"&&(this.title=a,this.childTitle.innerHTML=this.title)},setIcon:function(a){typeof a=="string"&&a!==""&&(this.iconUrl=a,this.childIcon.src=this.iconUrl)},onClose:function(a){return function(){a.active=!1,a.window=null}},onMove:function(a){return function(b,c){if($&&$.cookies&&$.md5){var d={expiresAt:new Date(2099,12,31)};$.cookies.set($.md5(a.title+"_wx"),b+"",d),$.cookies.set($.md5(a.title+"_wy"),c+"",d)}}},onResize:function(a){return function(b,c,d){if($&&$.cookies&&$.md5){var e={expiresAt:new Date(2099,12,31)};switch(d){case"resize":$.cookies.set($.md5(a.title+"_ww"),b+"",e),$.cookies.set($.md5(a.title+"_wh"),c+"",e);break;case"maximize":$.cookies.set($.md5(a.title+"_ws"),"maximized",e);break;case"restore":$.cookies.set($.md5(a.title+"_ws"),"window",e)}}}},CLASS_NAME:"Weiran.App"}),Weiran.Widget=Weiran.Class({div:null,title:null,baseZIndex:1e3,initialize:function(){},draw:function(){return this.div=document.createElement("div"),this.div.id=Weiran.createUniqueID("weWidgetID_"),this.div.style.zIndex=this.baseZIndex+Weiran.lastSeqID,this.title&&(this.div.title=this.title),this.div},destroy:function(){var a=this.div.parentNode;a&&a.removeChild&&a.removeChild(this.div),this.div=null},CLASS_NAME:"Weiran.Widget"}),Weiran.Widget.Taskbar=Weiran.Class(Weiran.Widget,{draw:function(){return Weiran.Widget.prototype.draw.apply(this,arguments),this.div&&(this.div.className="weWidgetTaskbar"),this.div},CLASS_NAME:"Weiran.Widget.Taskbar"}),Weiran.Lang.add("en","weMainPanelTitle","Main Panel"),Weiran.Lang.add("en","weMainPanelConfirm","Press [OK] to close, or [Cancel] to minimize the window."),Weiran.Lang.add("zh-CN","weMainPanelTitle","系统面板"),Weiran.Lang.add("zh-CN","weMainPanelConfirm","按【确认】关闭，或按【取消】最小化窗口。"),Weiran.Widget.MainPanel=Weiran.Class(Weiran.Widget,{mainDiv:null,window:null,windowOpened:!1,apps:null,initialize:function(){Weiran.Widget.prototype.initialize.apply(this,arguments),this.title=Weiran.i18n("weMainPanelTitle"),this.apps=[]},draw:function(){return Weiran.Widget.prototype.draw.apply(this,arguments),this.div.className="weWidgetMainPanel",this.mainDiv=document.createElement("div"),this.mainDiv.className="weWidgetMainPanelContent",Weiran.Event.observe(this.div,"click",Weiran.Function.bindAsEventListener(this.onClick,this)),this.div},destroy:function(){if(this.apps){for(var a=this.apps.length-1;a>=0;a--)this.delApp(this.apps[a]),this.apps[a].destroy();this.apps=null}this.windowOpened&&(this.window.close(),this.window=null,this.windowOpened=!1),this.mainDiv&&(this.mainDiv=null),Weiran.Event.stopObservingElement(this.div),Weiran.Widget.prototype.destroy.apply(this,arguments)},onClick:function(a){if(typeof Weiran!="object")return;var b=Weiran.theOS.getManager();this.windowOpened?this.window.select():(this.window=b.createWindow({title:this.title,centered:!0,width:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_ww")):null,height:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_wh")):null,x:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_wx")):null,y:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_wy")):null,state:$&&$.cookies&&$.md5?$.cookies.get($.md5(this.title+"_ws")):"window",iconImageURL:Weiran.imagePath+"main_icon.png"}),this.window.getComponent("content").innerHTML="",this.window.getComponent("content").appendChild(this.mainDiv),this.window.getComponent("close").onclick=function(a){return function(){confirm(Weiran.i18n("weMainPanelConfirm"))?a.close():a._iconify()}}(this.window),this.windowOpened=!0,this.window.onclose=this.onClose(this),this.window.onmove=this.onMove(this),this.window.onresize=this.onResize(this)),a!=null&&Weiran.Event.stop(a)},onClose:function(a){return function(){a.windowOpened=!1,a.window=null}},onMove:function(a){return function(b,c){if($&&$.cookies&&$.md5){var d={expiresAt:new Date(2099,12,31)};$.cookies.set($.md5(a.title+"_wx"),b+"",d),$.cookies.set($.md5(a.title+"_wy"),c+"",d)}}},onResize:function(a){return function(b,c,d){if($&&$.cookies&&$.md5){var e={expiresAt:new Date(2099,12,31)};switch(d){case"resize":$.cookies.set($.md5(a.title+"_ww"),b+"",e),$.cookies.set($.md5(a.title+"_wh"),c+"",e);break;case"maximize":$.cookies.set($.md5(a.title+"_ws"),"maximized",e);break;case"restore":$.cookies.set($.md5(a.title+"_ws"),"window",e)}}}},addApp:function(a){a instanceof Weiran.App&&(this.apps.push(a),this.mainDiv.appendChild(a.draw()))},delApp:function(a){a instanceof Weiran.App&&(this.mainDiv.removeChild(a.div),Weiran.removeItem(this.apps,a),a.active&&a.window&&(a.window.close(),a.window=null,a.active=!1))},clearApps:function(){if(this.apps){for(var a=this.apps.length-1;a>=0;a--)this.delApp(this.apps[a]),this.apps[a].destroy();this.apps=[]}},getAllApps:function(){return this.apps},CLASS_NAME:"Weiran.Widget.MainPanel"}),Weiran.Lang.add("en","weTitleBarWelcome","Welcome: "),Weiran.Lang.add("en","weTitleBarAnonymous","Anonymous"),Weiran.Lang.add("zh-CN","weTitleBarWelcome","欢迎您: "),Weiran.Lang.add("zh-CN","weTitleBarAnonymous","匿名用户"),Weiran.Widget.TitleBar=Weiran.Class(Weiran.Widget,{spanWelcome:null,spanAccount:null,draw:function(){return Weiran.Widget.prototype.draw.apply(this,arguments),this.div.className="weWidgetTitleBar",this.spanWelcome=document.createElement("span"),this.spanWelcome.className="weWidgetTitleBarWelcome",this.spanWelcome.innerHTML=Weiran.i18n("weTitleBarWelcome"),this.div.appendChild(this.spanWelcome),this.spanAccount=document.createElement("span"),this.spanAccount.className="weWidgetTitleBarAccount",this.spanAccount.innerHTML=Weiran.i18n("weTitleBarAnonymous"),this.div.appendChild(this.spanAccount),this.div},setAccount:function(a){typeof a=="string"&&(this.spanAccount.innerHTML=acccount)},CLASS_NAME:"Weiran.Widget.TitleBar"}),Weiran.OS=Weiran.Class({div:null,mainPanel:null,titleBar:null,taskbar:null,map:null,wm:null,accountDataHost:null,theme:"default",events:null,EVENT_TYPES:["signin","login","logout"],account:null,socket:null,initialize:function(a,b){this.div=document.getElementById(a);if(!this.div){alert("invalid canvas id");return}this.div.className="weOS",this.accountDataHost=b,Weiran.theOS!=null&&Weiran.theOS.exit(),Weiran.theOS=this,OpenLayers.ProxyHost="/cgi-bin/proxy.cgi?url="},boot:function(){if(!this.div)return;var a=Weiran.getScriptLocation()+"theme/"+this.theme+"/style.css";Weiran.loadCssFile(document,a),this.updateImgPath(),this.events=new Weiran.Events(this,null,this.EVENT_TYPES,!0),this.mainPanel=new Weiran.Widget.MainPanel,this.div.appendChild(this.mainPanel.draw()),this.titleBar=new Weiran.Widget.TitleBar,this.div.appendChild(this.titleBar.draw()),this.taskbar=new Weiran.Widget.Taskbar,this.div.appendChild(this.taskbar.draw()),this.createMapInstance(),this.createWindowManager(),this.events.register("signin",this,this.onSignIn),this.events.register("logout",this,this.onLogOut)},exit:function(){this.map!=null&&(this.map.destroy(),this.sensorsLayer=null,this.map=null),this.events!=null&&(this.events.destroy(),this.events=null);var a=this.wm.getAllWindows();for(var b=0;b<a.length;b++)a[b].close();this.wm=null,this.titleBar&&(this.titleBar.destroy(),this.titleBar=null),this.taskbar&&(this.taskbar.destroy(),this.taskbar=null),this.mainPanel&&(this.mainPanel.destroy(),this.mainPanel=null)},updateImgPath:function(){Weiran.imagePath=Weiran.getScriptLocation()+"theme/"+this.theme+"/img/",OpenLayers.ImgPath=Weiran.imagePath},createWindowManager:function(){this.wm=new jwim.Manager({container:this.div,taskbar:this.taskbar.div,defaultX:50,defaultY:35,iconWidth:36,cacheXHR:!0})},createMapInstance:function(){this.map=new OpenLayers.Map(this.div,{theme:null,projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),units:"m",maxResolution:156543.0339,maxExtent:new OpenLayers.Bounds(-20037509,-20037508.34,20037508.34,20037508.34),layers:[new OpenLayers.Layer.OSM(OpenLayers.i18n("OSM_Mapnik"),["http://a.tile.openstreetmap.org/${z}/${x}/${y}.png","http://b.tile.openstreetmap.org/${z}/${x}/${y}.png","http://c.tile.openstreetmap.org/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='http://www.openstreetmap.org/' >Open Street Map</a>"}),new OpenLayers.Layer.OSM(OpenLayers.i18n("OSM_Osmarender"),["http://a.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png","http://b.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png","http://c.tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='http://www.openstreetmap.org/' >Open Street Map</a>",numZoomLevels:18}),new OpenLayers.Layer.OSM(OpenLayers.i18n("OSM_Cycle"),["http://a.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png","http://b.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png","http://c.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='http://www.opencyclemap.org/' >Open Cycle Map</a>",numZoomLevels:17}),new OpenLayers.Layer.OSM(OpenLayers.i18n("OSM_Transport"),["http://a.tile2.opencyclemap.org/transport/${z}/${x}/${y}.png","http://b.tile2.opencyclemap.org/transport/${z}/${x}/${y}.png","http://c.tile2.opencyclemap.org/transport/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='http://www.opencyclemap.org/' >Open Cycle Map</a>"}),new OpenLayers.Layer.OSM(OpenLayers.i18n("OSM_MapQuest"),["http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png","http://otile2.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png","http://otile3.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png","http://otile4.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png"],{attribution:"Tiles @ <a target='_blank' href='http://www.mapquest.com/' >MapQuest Open</a>"})],controls:[new OpenLayers.Control.Navigation,new OpenLayers.Control.KeyboardDefaults,new OpenLayers.Control.PanZoomBar({position:new OpenLayers.Pixel(2,2)}),new OpenLayers.Control.Attribution,new OpenLayers.Control.ScaleLine({maxWidth:150,geodesic:!0}),new OpenLayers.Control.MousePosition({numDigits:6,displayProjection:new OpenLayers.Projection("EPSG:4326")}),new OpenLayers.Control.LoadingPanel,new OpenLayers.Control.WeOverviewMap]});if($&&$.cookies&&$.md5){var a=$.cookies.get($.md5(this.CLASS_NAME+"_mapcenterlon")),b=$.cookies.get($.md5(this.CLASS_NAME+"_mapcenterlat")),c=$.cookies.get($.md5(this.CLASS_NAME+"_mapzoom")),d=this.map.getMaxExtent();a!==null&&b!==null&&c!==null?this.map.setCenter((new OpenLayers.LonLat(a,b)).transform(this.map.displayProjection,this.map.getProjectionObject()),c):this.map.setCenter(d.getCenterLonLat(),this.map.getZoomForExtent(d)+1)}else this.map.setCenter(d.getCenterLonLat(),this.map.getZoomForExtent(d)+1);this.map.events.register("moveend",this,this.onMapMoveEnd),this.map.events.register("zoomend",this,this.onMapZoomEnd)},createSocket:function(){if(typeof this.accountDataHost!="string"||this.accountDataHost==="")return;this.socket!=null&&(this.socket.disconnect&&this.socket.disconnect(),this.socket=null),this.socket=io.connect(this.accountDataHost),this.socket!=null&&(this.socket.on("connect",this.onSocketConnect(this)),this.socket.on("disconnect",this.onSocketDisconnect(this)),this.socket.on("message",this.onSocketMessage(this)),this.socket.on("data",this.onSocketData(this)))},createAccount:function(){var a=new OpenLayers.Layer.WeAccounts;this.map&&this.map.addLayer(a),this.account=new Weiran.Sensor.Account({title:OpenLayers.i18n("WeAccount_name"),lon:0,lat:0,iconurl:OpenLayers.Util.getImagesLocation()+"we_account.png",realtimeserver:this.accountDataHost}),a.addMarker(this.account)},changeTheme:function(a){var b,c,d;if(a&&a!=this.theme){b=Weiran.getScriptLocation(),c=b+"theme/"+a+"/style.css",d=b+"theme/"+this.theme+"/style.css",Weiran.replaceCssFile(document,d,c),this.theme=a,this.updateImgPath();var e=this.map.getControlsByClass("OpenLayers.Control.PanZoomBar");e&&e.length>0&&e[0].redraw()}},onMapMoveEnd:function(a){if($&&$.cookies&&$.md5){var b=this.map.getCenter().transform(this.map.getProjectionObject(),this.map.displayProjection);$.cookies.set($.md5(this.CLASS_NAME+"_mapcenterlon"),b.lon+"",{expiresAt:new Date(2099,12,32)}),$.cookies.set($.md5(this.CLASS_NAME+"_mapcenterlat"),b.lat+"",{expiresAt:new Date(2099,12,32)}),b=null}},onMapZoomEnd:function(a){$&&$.cookies&&$.md5&&$.cookies.set($.md5(this.CLASS_NAME+"_mapzoom"),this.map.getZoom()+"",{expiresAt:new Date(2099,12,32)})},onSocketConnect:function(a){return function(){}},onSocketDisconnect:function(a){return function(){}},onSocketMessage:function(a){return function(a){}},onSocketData:function(a){return function(a){}},onSignIn:function(a){if(!a.account)return;this.applyAccountData(a.account)},applyAccountData:function(a){var b;a.lon&&a.lat&&this.map.setCenter((new OpenLayers.LonLat(a.lon,a.lat)).transform(this.map.displayProjection,this.map.getProjectionObject()),5),a.theme&&this.changeTheme(a.theme),this.accountsLayer==null&&(this.accountsLayer=new OpenLayers.Layer.WeSensors(OpenLayers.i18n("WeSensors_users")),this.map.addLayer(this.accountsLayer),this.accountsLayer.addSensor(new OpenLayers.WeSensor.WeAccount(a)));if(a.sensors&&a.sensors.length>0&&this.sensorsLayer==null){this.sensorsLayer=new OpenLayers.Layer.WeSensors,this.map.addLayer(this.sensorsLayer);for(b=0;b<a.sensors.length;b++)switch(a.sensors[b].type.toLowerCase()){case"wegt02a":this.sensorsLayer.addSensor(new OpenLayers.WeSensor.WeGT02A(a.sensors[b]));break;default:}}},onLogOut:function(a){this.accountsLayer!=null&&(this.map.removeLayer(this.accountsLayer),this.accountsLayer.destroy(),this.accountsLayer=null),this.sensorsLayer!=null&&(this.map.removeLayer(this.sensorsLayer),this.sensorsLayer.destroy(),this.sensorsLayer=null),this.account=null},getMap:function(){return this.map},getManager:function(){return this.wm},getEvents:function(){return this.events},getMainPanel:function(){return this.mainPanel},getSocket:function(){return this.socket},getAccount:function(){return this.account},CLASS_NAME:"Weiran.OS"});