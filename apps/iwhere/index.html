<!DOCTYPE html>
<html>
<head>
<title>iWhere</title>
<meta charset=utf-8>
<script src=http://weapp.googlecode.com/svn/api/weapp.min.js></script>
<style type=text/css>body{font-size:smaller}label:hover{cursor:pointer;text-decoration:underline}#locate{margin-top:10px;width:180px;text-align:center}</style>
<script>WeApp.IWhere=top.Weiran.Class(WeApp,{geolocate:null,layer:null,initialize:function(a){WeApp.prototype.initialize.apply(this,arguments);this.i18n();top.jQuery("#bindLabel",document).text(top.Weiran.i18n(this.CLASS_NAME+"_bind"));top.jQuery("#watchLabel",document).text(top.Weiran.i18n(this.CLASS_NAME+"_watch"));top.jQuery("#accurateLabel",document).text(top.Weiran.i18n(this.CLASS_NAME+"_accurate"));top.jQuery("#locate",document).val(top.Weiran.i18n(this.CLASS_NAME+"_locate"));this.geolocate=new top.OpenLayers.Control.Geolocate({bind:false,watch:false,geolocationOptions:{enableHighAccuracy:false}});this.getMap().addControl(this.geolocate);this.layer=new top.OpenLayers.Layer.Vector(this.getTitle());this.getMap().addLayer(this.layer)},run:function(){WeApp.prototype.run.apply(this,arguments);this.geolocate.bind=top.jQuery("#bind",document).attr("checked");this.geolocate.watch=top.jQuery("#watch",document).attr("checked");this.geolocate.geolocationOptions.enableHighAccuracy=top.jQuery("#accurate",document).attr("checked");top.jQuery("#bind",document).change(top.Weiran.Function.bind(this.onBind,this));top.jQuery("#watch",document).change(top.Weiran.Function.bind(this.onWatch,this));top.jQuery("#accurate",document).change(top.Weiran.Function.bind(this.onAccurate,this));top.jQuery("#locate",document).click(top.Weiran.Function.bind(this.onLocate,this));this.geolocate.events.register("locationupdated",this,this.onPosUpdate);this.geolocate.events.register("locationfailed",this,this.onPosError);this.geolocate.events.register("locationuncapable",this,this.onPosUncapable);this.geolocate.events.register("activate",this,this.onActivate);this.geolocate.events.register("deactivate",this,this.onDeactivate)},destroy:function(){this.getMap().removeLayer(this.layer);this.layer.destroy();this.layer=null;this.getMap().removeControl(this.geolocate);this.geolocate.destroy();this.geolocate=null;WeApp.prototype.destroy.apply(this,arguments)},i18n:function(){top.Weiran.Lang.add("en",this.CLASS_NAME+"_bind","Bind map");top.Weiran.Lang.add("en",this.CLASS_NAME+"_watch","Watch position");top.Weiran.Lang.add("en",this.CLASS_NAME+"_accurate","Enable high accuracy");top.Weiran.Lang.add("en",this.CLASS_NAME+"_locate","Locate me");top.Weiran.Lang.add("en",this.CLASS_NAME+"_unlocate","Stop tracking");top.Weiran.Lang.add("zh-CN",this.CLASS_NAME+"_bind","绑定地图");top.Weiran.Lang.add("zh-CN",this.CLASS_NAME+"_watch","跟踪位置");top.Weiran.Lang.add("zh-CN",this.CLASS_NAME+"_accurate","启用高精度定位");top.Weiran.Lang.add("zh-CN",this.CLASS_NAME+"_locate","开始定位");top.Weiran.Lang.add("zh-CN",this.CLASS_NAME+"_unlocate","结束跟踪")},onBind:function(a){this.geolocate.bind=a.currentTarget.checked?true:false},onWatch:function(a){this.geolocate.watch=a.currentTarget.checked?true:false},onAccurate:function(a){this.geolocate.geolocationOptions.enableHighAccuracy=a.currentTarget.checked?true:false},onLocate:function(a){if(this.geolocate.active){this.geolocate.deactivate()}else{this.geolocate.activate()}},onPosUpdate:function(a){if(!this.geolocate.watch){this.geolocate.deactivate()}this.layer.removeAllFeatures();this.layer.addFeatures([new top.OpenLayers.Feature.Vector(a.point,{},{graphicName:"cross",strokeColor:"red",strokeWidth:2,fillOpacity:0,pointRadius:10}),new top.OpenLayers.Feature.Vector(top.OpenLayers.Geometry.Polygon.createRegularPolygon(new top.OpenLayers.Geometry.Point(a.point.x,a.point.y),a.position.coords.accuracy/2,40,0),{},{fillColor:"blue",fillOpacity:0.1,strokeWidth:0})]);if(this.geolocate.bind){this.getMap().zoomToExtent(this.layer.getDataExtent())}},onPosError:function(a){this.geolocate.deactivate();alert(a.error)},onPosUncapable:function(){top.Weiran.require(document,["http://j.maxmind.com/app/geoip.js"],top.Weiran.Function.bind(function(){var a=new top.OpenLayers.LonLat(geoip_longitude(),geoip_latitude()).transform(this.getMap().displayProjection,this.getMap().getProjectionObject());this.geolocate.events.triggerEvent("locationupdated",{position:{coords:{longitude:geoip_longitude(),latitude:geoip_latitude(),accuracy:50000}},point:new top.OpenLayers.Geometry.Point(a.lon,a.lat)})},this));this.geolocate.deactivate()},onActivate:function(){top.jQuery("#locate",document).val(top.Weiran.i18n(this.CLASS_NAME+"_unlocate"))},onDeactivate:function(){top.jQuery("#locate",document).val(top.Weiran.i18n(this.CLASS_NAME+"_locate"))},CLASS_NAME:"WeApp.IWhere"});</script>
</head>
<body>
<input type=checkbox name=bind id=bind checked=checked />
<label for=bind id=bindLabel></label>
<br />
<input type=checkbox name=watch id=watch />
<label for=watch id=watchLabel></label>
<br />
<input type=checkbox name=accurate id=accurate />
<label for=accurate id=accurateLabel></label>
<br />
<input type=button id=locate value="Locate me"/>
<script>var app=new WeApp.IWhere();app.run();</script>
</body>
</html>
